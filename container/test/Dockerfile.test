# Test Dockerfile based on Dockerfile.dev but configured for testing
FROM catnip:latest

# Pre-create live directory and project directory with correct ownership
RUN mkdir -p /live && chown -R catnip:catnip /live
RUN mkdir -p /live/catnip/node_modules && chown -R catnip:catnip /live/catnip

# Create Go cache directories with correct ownership
RUN mkdir -p /home/catnip/.cache/go-build && \
    chown -R catnip:catnip /home/catnip/.cache

# Switch to catnip user for development
USER catnip
WORKDIR /workspace

# Install Air and swag for Go hot reloading with cache mount
RUN --mount=type=cache,target=/home/catnip/.cache/go-build,uid=1000,gid=1000 \
    --mount=type=cache,target=/home/catnip/go/pkg/mod,uid=1000,gid=1000 \
    bash -c 'source /etc/profile.d/catnip.sh && go install github.com/air-verse/air@latest && go install github.com/swaggo/swag/cmd/swag@latest'

# Copy test-specific scripts
COPY --chown=catnip:catnip container/test/scripts/test-entrypoint.sh ./test-entrypoint.sh
RUN chmod +x ./test-entrypoint.sh

# Copy mock scripts and test data
COPY --chown=catnip:catnip container/test/mocks /opt/catnip/test/bin
COPY --chown=catnip:catnip container/test/data /opt/catnip/test/data
RUN chmod +x /opt/catnip/test/bin/*

# Set test environment variables
ENV CATNIP_TEST_MODE=1
ENV CATNIP_PORT=8181
ENV CATNIP_TEST_DATA_DIR=/opt/catnip/test/data
ENV PATH=/opt/catnip/test/bin:$PATH

# Expose test port
EXPOSE 8181
USER root

# Use test entrypoint
ENTRYPOINT ["/entrypoint.sh", "./test-entrypoint.sh"]